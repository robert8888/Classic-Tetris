(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const n of o.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&s(n)}).observe(document,{childList:!0,subtree:!0});function e(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(i){if(i.ep)return;i.ep=!0;const o=e(i);fetch(i.href,o)}})();const C={size:{standard:{col:10,row:22},big:{col:12,row:26},large:{col:14,row:30}},levels:[{name:"1",stepTime:1e3,pointForRow:100,pointLimit:1e3},{name:"1",stepTime:1e3,pointForRow:125,pointLimit:2250},{name:"2",stepTime:950,pointForRow:150,pointLimit:3750},{name:"3",stepTime:900,pointForRow:250,pointLimit:7250},{name:"4",stepTime:850,pointForRow:300,pointLimit:9250},{name:"5",stepTime:800,pointForRow:350,pointLimit:12750},{name:"6",stepTime:750,pointForRow:400,pointLimit:16750},{name:"7",stepTime:700,pointForRow:500,pointLimit:21750},{name:"8",stepTime:650,pointForRow:550,pointLimit:27250},{name:"9",stepTime:600,pointForRow:600,pointLimit:33250},{name:"10",stepTime:550,pointForRow:650,pointLimit:39750},{name:"11",stepTime:500,pointForRow:700,pointLimit:46750},{name:"12",stepTime:450,pointForRow:800,pointLimit:54750},{name:"13",stepTime:400,pointForRow:900,pointLimit:63750},{name:"14",stepTime:350,pointForRow:1e3,pointLimit:73750},{name:"15",stepTime:300,pointForRow:1100,pointLimit:84750},{name:"16",stepTime:250,pointForRow:1200,pointLimit:96750},{name:"17",stepTime:200,pointForRow:1500,pointLimit:99750},{name:"18",stepTime:150,pointForRow:2e3,pointLimit:12e4},{name:"19",stepTime:100,pointForRow:3e3,pointLimit:15e4},{name:"20",stepTime:50,pointForRow:5e3,pointLimit:2e5}]};class V{constructor(t){this.size=["standard","big","large"][0],this.queueVisible=!0,this.showProjection=!0,this.autoRotate=!1,this.score=0,this.level=0,this.comboFactor=0,this.paused=!1,this.gameOver=!1,this.pauseStartTime=null,this.softDrop=!1,this.hardDrop=!1,this.step=0,this.lastSuccess=null,this.currentShape=null,this.shapePosition={row:null,col:null},this.shapeProjectionPosition={row:null,col:null},this.shapeQueue=[],this.startTime=new Date().getTime(),this.map=null}export(){return JSON.parse(JSON.stringify({score:this.score,level:this.level,combo:this.comboFactor,time:new Date().getTime()-this.startTime,gameOver:this.gameOver,paused:this.paused,queueVisible:this.queueVisible,showProjection:this.showProjection,shapeQueue:this.shapeQueue,currentShape:this.currentShape,shapePosition:this.shapePosition,shapeProjectionPosition:this.shapeProjectionPosition,map:this.map}))}}const I={actions:{moveLeft:["ArrowLeft"],moveRight:"ArrowRight",softDrop:"ArrowDown",hardDrop:"Space",rotate:"ArrowUp",pause:"Escape",backRotate:"KeyZ",autoRotate:"KeyR"}};class O{constructor(t){t?this._config=t:this._config=I}get(t){for(let e in this._config.actions){let s=this._config.actions[e];if(s===t||s instanceof Array&&s.includes(t))return e}}}class U{constructor(){this.names=["block"]}}class p extends U{constructor(){super(...arguments),this.names.push("empty"),this.type="empty"}}class f extends U{constructor(t,e){super(...arguments),this.names.push("Shape"),this.names.push(t),this.type="shape",this._color=e}get color(){return this.color}}class b{constructor(t){}getEmptySquareMatrix(t){return this.getEmptyMatrix(t,t)}getEmptyMatrix(t,e){return new Array(t).fill(null).map(s=>new Array(e).fill(null))}}class w{constructor(t,e){this._size=t.shape.length,this._color=t.color,this._name=t.name,this._rotation=0,this._internalMatrix=new b().getEmptySquareMatrix(this._size);for(let s=0;s<this._size;s++)for(let i=0;i<this.size;i++)t.shape[s][i]?this._internalMatrix[s][i]=new f(this.name,this.color):this._internalMatrix[s][i]=new p}get size(){return this._size}get name(){return this._name}get color(){return this._color}get rotation(){return this._rotation}set rotation(t){this._rotation=t}*getBlockByRow(t){for(let e=0;e<this.size;e++)yield this.getBlockFrom({col:e,row:t})}*getBlockByCol(t){for(let e=0;e<this.size;e++)yield this.getBlockFrom({col:t,row:e})}*getAllBlocks(){for(let t=0;t<this.size;t++)for(let e=0;e<this.size;e++)yield{row:t,col:e,block:this.getBlockFrom({col:e,row:t})}}getBlockFrom(t){return this._internalMatrix[t.row][t.col]}}const v={Z:{name:"Z-shape",color:"red",shape:[[1,1,0],[0,1,1],[0,0,0]]},S:{name:"S-shape",color:"green",shape:[[0,1,1],[1,1,0],[0,0,0]]},J:{name:"J-shape",color:"blue",shape:[[1,1,1],[0,0,1],[0,0,0]]},L:{name:"L-shape",color:"orange",shape:[[1,1,1],[1,0,0],[0,0,0]]},T:{name:"T-shape",color:"purple",shape:[[1,1,1],[0,1,0],[0,0,0]]},O:{name:"O-shape",color:"yellow",shape:[[1,1],[1,1]]},I:{name:"I-shape",color:"cyan",shape:[[1,1,1,1],[0,0,0,0],[0,0,0,0],[0,0,0,0]]}};class H extends w{constructor(){super(v.I)}}class K extends w{constructor(){super(v.J)}}class $ extends w{constructor(){super(v.L)}}class W extends w{constructor(){super(v.O)}}class Z extends w{constructor(){super(v.T)}}class J extends w{constructor(){super(v.Z)}}class N extends w{constructor(){super(v.S)}}class Q extends Array{constructor(){super(),this.push(H),this.push(K),this.push($),this.push(W),this.push(N),this.push(Z),this.push(J)}}class j{constructor(){}_getRandomNumber(t){this._c=2147483648,this._c--;const e=0xb804cf5d22c,s=4546432168545;let o=new Date().getTime()*Math.random()*this._c;return o=Math.floor(o)+e,o%=s,o%=t,o}}class D extends j{constructor(){super(...arguments),this._shapes=new Q}getRandom(){let t=this._getRandomNumber(this._shapes.length);return new this._shapes[t]}}class E{constructor(){}hasEmptyRow(t,e){if(e>=t.size)return!1;for(let s of t.getBlockByRow(e))if(s instanceof f)return!1;return!0}hasEmptyCol(t,e){if(e>=t.size)return!1;for(let s of t.getBlockByCol(e))if(s instanceof f)return!1;return!0}isBlockEmpty(t,e){return!(t.getBlockFrom(e)instanceof f)}fieldHeight(t,e){for(let s=t.size-1;s>=0;s--)if(t.getBlockFrom({row:s,col:e})instanceof f)return s;return-1}emptyWidth(t,e){for(let s=0;s<t.size;s++)if(t.getBlockFrom({row:e,col:s})instanceof f)return s;return 0}filedWidth(t,e){for(let s=t.size-1;s>=0;s--)if(t.getBlockFrom({row:e,col:s})instanceof f)return s;return-1}getOrientation(t){let e=0,s=0;for(let i=0;i<t.size;i++)this.hasEmptyCol(t,i)&&s++,this.hasEmptyRow(t,i)&&e++;return s<e?"horizontal":"vertical"}}class G{constructor(){this._shapeControler=new E}rotateTo(t,e){for(;t.rotation!==parseInt(e);)this.rotate(t)}backRotateTo(t,e){for(;t.rotation!==parseInt(e);)this.backRotate(t)}rotate(t){let e=new b().getEmptySquareMatrix(t.size);for(let s=0;s<t.size;s++)for(let i=0;i<t.size;i++)e[s][t.size-1-i]=t.getBlockFrom({row:i,col:s});t._internalMatrix=e,this._shiftRight(t),this._shiftUp(t),t.rotation=(t.rotation+1)%4}backRotate(t){let e=new b().getEmptySquareMatrix(t.size);for(let s=0;s<t.size;s++)for(let i=0;i<t.size;i++)e[t.size-1-i][s]=t.getBlockFrom({row:s,col:i});t._internalMatrix=e,this._shiftLeft(t),this._shiftUp(t),t.rotation=t.rotation===0?3:t.rotation-1}_shiftRight(t){for(;this._shapeControler.hasEmptyCol(t,t.size-1);)for(let e=0;e<t.size;e++){for(let s=t.size-1;s>0;s--)t._internalMatrix[e][s]=t._internalMatrix[e][s-1];t._internalMatrix[e][0]=new p}}_shiftLeft(t){for(;this._shapeControler.hasEmptyCol(t,0);)for(let e=0;e<t.size;e++){for(let s=1;s<t.size;s++)t._internalMatrix[e][s-1]=t._internalMatrix[e][s];t._internalMatrix[e][t.size-1]=new p}}_shiftUp(t){for(;this._shapeControler.hasEmptyRow(t,0);)for(let e=1;e<=t.size;e++)for(let s=0;s<t.size;s++)e===t.size?t._internalMatrix[t.size-1][s]=new p:t._internalMatrix[e-1][s]=t._internalMatrix[e][s]}}let X=class{constructor(t){this._size=t,this.build(t)}set size(t){this._size=t}get size(){return this._size}get rowCount(){return this._internalMatrix.length}get colCount(){return this._internalMatrix[0].length}build(t){t=t||this._size,this._internalMatrix=new b().getEmptyMatrix(t.row,t.col).map(e=>e=e.map(s=>new p))}setBlockOn(t,e){this._internalMatrix[e.row][e.col]=t}getBlockFrom(t){return this._internalMatrix[t.row][t.col]}};class Y{constructor(t){this._map=t}add(t,e){for(let s=0;s<t.size;s++)this.addRow(t,e,s)}addRow(t,e,s){for(let i=0;i<t.size;i++){let o=t.getBlockFrom({row:s,col:i});o instanceof f&&this._map.setBlockOn(o,{row:e.row+s,col:e.col+i})}}remove(t){t.forEach(e=>{for(let s=0;s<this._map.size.col;s++)this._map.setBlockOn(null,{row:e,col:s});for(let s=e;s>1;s--)for(let i=0;i<this._map.size.col;i++){let o=this._map.getBlockFrom({row:s-1,col:i});this._map.setBlockOn(o,{row:s,col:i})}e=0;for(let s=0;s<this._map.size.col;s++)this._map.setBlockOn(new p,{row:e,col:s})})}}class q{constructor(t){this._map=t}findCompleted(){let t=[];for(let e=0;e<this._map.rowCount;e++){let s=!0;for(let i=0;i<this._map.colCount;i++)this._map.getBlockFrom({row:e,col:i})instanceof p&&(s=!1);s&&t.push(e)}return t.hasResults=t.length>0,t}isFinished(){let t=!1;const e=2;for(let s=0;s<this._map.colCount;s++)this._map.getBlockFrom({row:e,col:s})instanceof f&&(t=!0);return t}isCordInMap(t){return!(t.row>=this._map.rowCount||t.col>=this._map.colCount||t.col<0)}isCordInMapReason(t){return t.row>=this._map.rowCount?{value:!1,reason:"row out of bottom"}:t.col>=this._map.colCount?{value:!1,reason:"col ouf of right border"}:t.col<0?{value:!1,reason:"col out of left border"}:{value:!0,reason:null}}isFieldEmpty(t){return this.isCordInMap(t)?this._map.getBlockFrom(t)instanceof p:!1}isAccessible(t){return this.isCordInMap(t)?this._map.getBlockFrom(t)instanceof p:!1}isAccessibleReason(t){return this.isCordInMapReason(t).value?this._map.getBlockFrom(t)instanceof p?{value:!0,reason:null}:{value:!1,reason:"not empty block"}:{reason:this.isCordInMapReason(t).reason,value:!1}}}class tt{constructor(t){this._gameState=t,this._shapeController=new E,this._mapController=new q(t.map)}canDown(){const t=this._gameState.currentShape,e=this._gameState.shapePosition;return this.canMoveDown(t,e)}canMoveDown(t,e){const s=e;for(let i=0;i<t.size;i++){let o=this._shapeController.fieldHeight(t,i);if(o===-1)continue;let r={row:s.row+o+1,col:s.col+i};if(!this._mapController.isAccessible(r))return!1}return!0}canRightBy(t,e){let s=!1;for(let i=0;i<e;i++)s=this.canRight({row:t.row,col:t.col+i});return s}canRight(t){if(this._gameState.hardDrop)return!1;const e=this._gameState.currentShape,s=t||this._gameState.shapePosition;for(let i=0;i<e.size;i++){let o=this._shapeController.filedWidth(e,i);if(o===-1)continue;let r={col:s.col+o+1,row:s.row+i};if(!this._mapController.isAccessible(r))return!1}return!0}canLeftBy(t,e){let s=!1;for(let i=0;i<e;i++)s=this.canLeft({row:t.row,col:t.col-i});return s}canLeft(t){if(this._gameState.hardDrop)return!1;const e=this._gameState.currentShape,s=t||this._gameState.shapePosition;for(let i=0;i<e.size;i++){let o=this._shapeController.emptyWidth(e,i),r={col:s.col+o-1,row:s.row+i};if(!this._mapController.isAccessible(r))return!1}return!0}canRotate(t){if(this._gameState.hardDrop)return!1;let e=this._gameState.currentShape,s=t||this._gameState.shapePosition,i=!0,o=null;for(let n of e.getAllBlocks())if(!this._shapeController.isBlockEmpty(e,{col:n.col,row:n.row})){let r={row:n.col,col:e.size-n.row};r.row+=s.row,r.col+=s.col,r.col--;let{value:l,reason:c}=this._mapController.isAccessibleReason(r);l||(i=!1,o=c)}return{value:i,reason:o}}canBackRotate(){if(this._gameState.hardDrop)return!1;let t=this._gameState.currentShape,e=this._gameState.shapePosition,s=!0,i=null;for(let o of t.getAllBlocks())if(!this._shapeController.isBlockEmpty(t,{col:o.col,row:o.row})){let n={row:t.size-o.col,col:o.row};n.row+=e.row,n.col+=e.col;let{value:r,reason:l}=this._mapController.isAccessibleReason(n);r||(s=!1,i=l)}return{value:s,reason:i}}moveResult(){const t=this._gameState.map,e=this._gameState.currentShape,s={...this._gameState.shapePosition};for(;this.canMoveDown(e,s);)s.row++;let i=0;for(let o=s.col;o<s.col+e.size;o++){let n=o-s.col;if(this._shapeController.hasEmptyCol(e,n))continue;let r=!1;for(let l=s.row;l<t.rowCount;l++){let c,u;if(o>=s.col&&o<s.col+e.size&&l>=s.row&&l<s.row+e.size){let m=e.getBlockFrom({row:l-s.row,col:o-s.col});!r&&m instanceof f?(r=!0,c=!1):r?c=m instanceof p:c=!1}else c=!0;u=t.getBlockFrom({row:l,col:o})instanceof p,u&&u&&c&&i++}}return i}}class y{constructor(){}on(t,e){this.events||(this.events=new Map),this.events.set(t,e)}fire(t,...e){this.events&&this.events.has(t)&&this.events.get(t)(...e)}}class et extends y{constructor(t){super(),this._gameState=t,this._setup(t)}set state(t){this._gameState=t,this._setup(t)}_setup(t){this._mapUpdater=new Y(t.map),this._mapController=new q(t.map),this._moveController=new tt(t),this._shapeUpdater=new G,this._shapeControler=new E}has(t){return["moveLeft","moveRight","softDrop","hardDrop","rotate","backRotate","autoRotate","pause"].includes(t)}do(t){if(!this._gameState.gameOver)switch(t){case"moveDown":return this._moveDown();case"moveLeft":return this._moveLeft();case"moveRight":return this._moveRight();case"rotate":return this._rotate();case"backRotate":return this._backRotate();case"softDrop":return this._startSoftDrop();case"hardDrop":return this._startHardDrop();case"autoRotate":return this._autoRotate();case"pause":return this.fire("pause"),!0}}cancel(t){switch(t){case"softDrop":return this._stopSoftDrop()}}_moveDown(){if(this._moveController.canDown())this._gameState.shapePosition.row++,this._gameState.step++;else{this._gameState.hardDrop=!1,this._mapUpdater.add(this._gameState.currentShape,this._gameState.shapePosition),this.fire("newShape");let t=this._mapController.findCompleted();t.hasResults?(this._mapUpdater.remove(t),this.fire("completed",t.length),this._gameState.lastSuccess=!0):(this._gameState.lastSuccess=!1,this._gameState.comboFactor=0)}this._updateProjection(),this._mapController.isFinished()&&this.fire("gameOver"),this.fire("stateUpdate")}_moveLeft(){return this._moveController.canLeft()?(this._gameState.shapePosition.col--,this._updateProjection(),!0):!1}_moveRight(){return this._moveController.canRight()?(this._gameState.shapePosition.col++,this._updateProjection(),!0):!1}_rotate(){if(this._moveController.canRotate().value)return this._shapeUpdater.rotate(this._gameState.currentShape),this._updateProjection(),!0;if(this._moveController.canRotate().reason==="col out of left border"){let t=Math.abs(this._gameState.shapePosition.col);if(this._moveController.canRotate({col:0,row:this._gameState.shapePosition.row}).value&&this._moveController.canRightBy({...this._gameState.shapePosition},t)){for(let e=0;e<t;e++)this._moveRight();return this._rotate(),this._updateProjection(),!0}}return!1}_backRotate(){if(this._moveController.canBackRotate().value)return this._shapeUpdater.backRotate(this._gameState.currentShape),this._updateProjection(),!0;if(this._moveController.canBackRotate().reason==="col ouf of right border"){let t=this._gameState.shapePosition.col+this._gameState.currentShape.size-this._gameState.map.colCount;if(this._moveController.canBackRotate({row:this._gameState.shapePosition.row,col:this._gameState.map.colCount-this._gameState.currentShape.size})&&this._moveController.canLeftBy({...this._gameState.shapePosition},t)){for(let e=0;e<t;e++)this._moveLeft();return this._backRotate(),this._updateProjection(),!0}console.log("to do right wall kick")}return!1}_startSoftDrop(){return this._gameState.softDrop||(this._gameState.softDrop=!0),!0}_stopSoftDrop(){return this._gameState.softDrop&&(this._gameState.softDrop=!1),!0}_startHardDrop(){return this._gameState.hardDrop=!0,this.fire("hardDropInstant"),!0}_autoRotate(){if(!this._gameState.autoRotate)return!0;const t=this._gameState.currentShape;if(!this._rotate())return;const e=()=>{let n=1/0,r=[];const l=s();for(let c of Object.values(l))c<=n&&(n=c);for(let[c,u]of Object.entries(l))u==n&&r.push(parseInt(c));return{minRotation:r,min:n}},s=()=>{const n={};for(let r of[0,1,2,3])this._shapeUpdater.rotate(t),n[t.rotation]=this._moveController.moveResult(t);return console.log(n),n};let{minRotation:i}=e(),o={horizontal:null,vertical:null};for(let n of i){this._shapeUpdater.rotateTo(t,n);let r=this._shapeControler.getOrientation(t);o[r]=n}return o.horizontal!==null?this._shapeUpdater.rotateTo(t,o.horizontal):o.vertical!=null&&this._shapeUpdater.rotateTo(t,o.vertical),this._updateProjection(),!0}_updateProjection(){if(!this._gameState.showProjection){this._gameState.shapeProjectionPosition.col=-10,this._gameState.shapeProjectionPosition.row=-10;return}let t=Object.assign({},this._gameState.shapePosition);for(;this._moveController.canMoveDown(this._gameState.currentShape,t);)t.row++;this._gameState.shapeProjectionPosition=t}}class st extends y{constructor(){super()}createGame(t){this.userConfig=t,this._initialState(this.userConfig),this._setupShapes(),this._setupMap(),this._startPosition(),this._controler=new et(this._state),this._controler.on("completed",this._addPoint.bind(this)),this._controler.on("gameOver",this._gameOver.bind(this)),this._controler.on("newShape",this._nextShape.bind(this)),this._controler.on("stateUpdate",this._stateUpdate.bind(this)),this._controler.on("pause",this.togglePause.bind(this)),this._controler.on("hardDropInstant",()=>{clearTimeout(this.timer),this._tick(),this.fire("sound","hard drop")})}get state(){return this._state.export()}set keyConfiguration(t){this._keyConfig=new O(t)}get keyConfiguration(){return this._keyConfig||(this.userConfig.keyConfig?this._keyConfig=new O(this.userConfig.keyConfig):this._keyConfig=new O),this._keyConfig}keyDown(t){if(!this._state)return;let e=this.keyConfiguration.get(t);e&&(this._controler.do(e)?(this._stateUpdate(),this.fire("sound","move correct")):this.fire("sound","move fail"))}keyUp(t){if(!this._state)return;let e=this.keyConfiguration.get(t);e&&this._controler.cancel(e)&&this._stateUpdate()}action(t){if(this._controler.has(t))this._controler.do(t)?(this._stateUpdate(),this.fire("sound","move correct")):this.fire("sound","move fail");else throw Error(`invalid action name : ${t}`)}cancel(t){if(this._controler.has(t))this._controler.cancel(t)&&this._stateUpdate();else throw Error(`invalid action name : ${t}`)}start(){this._state.paused=!1,this._tick()}restart(){this._initialState(this.userConfig),this._setupShapes(),this._setupMap(),this._startPosition(),this._controler.state=this._state,clearTimeout(this.timer),this._tick(),this._stateUpdate()}togglePause(){if(!this._state.paused)this._state.paused=!0,this._state.pauseStartTime=new Date().getTime();else{this._state.paused=!1;const t=new Date().getTime()-this._state.pauseStartTime;this._state.startTime+=t,this._state.pauseStartTime=null,clearTimeout(this.timer),this._tick()}this._stateUpdate()}_tick(){if(!this._state.paused&&!this._state.gameOver){this._controler.do("moveDown");let t,e=1;this._state.hardDrop?t=50:t=C.levels[this._state.level].stepTime,this._state.softDrop&&(e=.5),this.timer=setTimeout(()=>this._tick(),t*e)}}_initialState(t){this._state=new V,this._state.size=t.gameConfig.size,this._state.queueVisible=t.gameConfig.queueVisible,this._state.showProjection=t.gameConfig.showProjection,this._state.autoRotate=t.gameConfig.autoRotate}_setupShapes(){const t=new D;for(let e=0;e<6;e++){let s=t.getRandom();this._rotateRandom(s),this._state.shapeQueue.push(s)}this._state.currentShape=t.getRandom()}_setupMap(){const t=C.size[this._state.size];this._state.map=new X(t),this._startPosition()}_rotateRandom(t){const e=new G;let s=new j;const i=s._getRandomNumber(4),o=s._getRandomNumber(2);for(let n=0;n<i;n++)o?e.backRotate(t):e.rotate(t)}_startPosition(){let t=0,e;const s=this._state.currentShape;new E().hasEmptyRow(s,2)&&(t=1),e=Math.floor(this._state.map.colCount/2)-Math.floor(this._state.currentShape.size/2),this._state.shapePosition.row=t,this._state.shapePosition.col=e,this._state.shapeProjectionPosition=Object.assign({},this._state.shapePosition)}_nextShape(){const t=new D;this._state.currentShape=this._state.shapeQueue.shift();let e=t.getRandom();this._rotateRandom(e),this._state.shapeQueue.push(e),this._startPosition(),this.fire("sound","shape add")}_addPoint(t){let e=C.levels[this._state.level],s=0;t===1?s=e.pointForRow:t>1&&(s=e.pointForRow*2,this._state.comboFactor+=t),this._state.lastSuccess?this._state.comboFactor+=2:this._state.comboFactor=0,this._state.comboFactor>0&&(s*=this._state.comboFactor),this._state.score+=s,this._state.score>=C.levels[this._state.level].pointLimit&&this._state.level++,this.fire("sound","completed row")}_stateUpdate(){this.fire("stateUpdate",this._state.export())}_gameOver(){this._state.gameOver=!0;const{score:t,level:e,startTime:s}=this._state;this.fire("gameOver",{score:t,level:e,time:new Date().getTime()-s}),this.fire("sound","game over")}}class S extends y{constructor(t){super(),this._state=t}}class it extends S{constructor(){super(...arguments),this._createGradients(),this._size={col:this._state.initGameState.map._size.col,row:this._state.initGameState.map._size.row}}render(){let t=this._state.root.group().addClass("game-map");const e=this._size.col,s=this._size.row;this._matrix=new b().getEmptyMatrix(s,e);let i=this._state.height/2/e-.15;const o=1;for(let n of this.elements()){let r=t.rect();r.width(i-o).height(i-o),r.dx(i*n.col).dy(i*n.row),this._matrix[n.row][n.col]=r}t.dy(-2*i),t.dx(this._state.width-i*e-2),this._state.squareSize=i}update(t){const e=t.map._internalMatrix,s=t.currentShape._internalMatrix,i=t.shapePosition,o=t.shapeProjectionPosition,n=t.currentShape._size;for(let r of this.elements()){r.rect.attr("class","");let l=e[r.row][r.col];if(r.col>=o.col&&r.col<o.col+n&&r.row>=o.row&&r.row<o.row+n){let c=Object.assign({},s[r.row-o.row][r.col-o.col]);c.type==="shape"&&(c.names.push("projection"),l=c)}if(r.col>=i.col&&r.col<i.col+n&&r.row>=i.row&&r.row<i.row+n){let c=s[r.row-i.row][r.col-i.col];c.type==="shape"&&(l=c)}for(let c of l.names)r.rect.addClass(c)}}*elements(){for(let t=0;t<this._size.row;t++)for(let e=0;e<this._size.col;e++)yield{row:t,col:e,rect:this._matrix[t][e]}}_createGradients(){let t=this._state.root;const e=["z-shape","s-shape","l-shape","j-shape","o-shape","i-shape","t-shape","empty","projection"];for(let s of e)t.gradient("radial",function(o){o.stop(0),o.stop(1)}).attr("id",s+"-gradient")}}class k{constructor(){}formatTime(t){let e=Math.floor(t/1e3)%60,s=Math.floor(t/1e3/60)%60;return{h:Math.floor(t/1e3/3600),m:s,s:e}}string(t){let{h:e,m:s,s:i}=this.formatTime(t);return` ${e?e+" :":""}${s?s+":":""}${i<10?"0"+i:i}`}stringDescribed(t){let e=this.formatTime(t);return` ${e.h?e.h+"h:":""}${e.m?e.m+"m:":""}${e.s}s`}}class ot extends S{constructor(){super(...arguments)}render(){const e=this._state.squareSize/2||30,s=this._state.squareSize||30,i=this._state.width-this._state.initGameState.map._size.col*this._state.squareSize-3,o=this._state.squareSize;let n=0,r=this._state.root.group().addClass("game-statistic"),l=r.group().addClass("combo");l.rect(i,o).dy(n*o),l.text(h=>{h.tspan("combo "),this.combo=h.tspan(this._state.initGameState.combo.toString())}).dx(15).cy(e+n++*s);let c=r.group().addClass("level");c.rect(i,o).dy(n*o),c.text(h=>{h.tspan("level "),this.level=h.tspan(this._state.initGameState.level.toString())}).dx(15).cy(e+n++*s);let u=r.group().addClass("score");u.rect(i,o).dy(n*o),u.text(h=>{h.tspan("score "),this.score=h.tspan(this._state.initGameState.level.toString())}).dx(15).cy(e+n++*s);let m=r.group().addClass("time");m.rect(i,o).dy(n*o),m.text(h=>{h.tspan("time "),this.time=h.tspan(new k().string(this._state.initGameState.time)).dx(10)}).dx(15).cy(e+n++*s)}update(t){this.combo.clear(),this.combo.text(t.combo.toString()),this.level.clear(),this.level.text(t.level.toString()),this.score.clear(),this.score.text(t.score.toString()),this.time.clear(),this.time.text(new k().string(t.time))}}class nt extends S{constructor(){super(...arguments)}render(){let t=document.createElement("div");t.classList.add("game-controls");let e=`<button class='controls-button-left'>LEFT</button>
                    <button class='controls-button-rotate'>ROTATE</button>
                    <button class='controls-button-back-rotate'>BACK ROTATE</button>
                    <button class='controls-button-right'>RIGHT</button>
                    <button class='controls-button-soft-drop'>SOFT DROP</button>
                    <button class='controls-button-hard-drop'>HARD DROP</button>`;t.innerHTML=e,t.getElementsByClassName("controls-button-left")[0].addEventListener("touchstart",()=>{this.fire("action","moveLeft")}),t.getElementsByClassName("controls-button-right")[0].addEventListener("touchstart",()=>{this.fire("action","moveRight")}),t.getElementsByClassName("controls-button-rotate")[0].addEventListener("touchstart",()=>{this.fire("action","rotate")}),t.getElementsByClassName("controls-button-back-rotate")[0].addEventListener("touchstart",()=>{this.fire("action","backRotate")}),t.getElementsByClassName("controls-button-hard-drop")[0].addEventListener("touchstart",()=>{this.fire("action","hardDrop")}),t.getElementsByClassName("controls-button-soft-drop")[0].addEventListener("touchstart",()=>{this.fire("action","softDrop")}),t.getElementsByClassName("controls-button-soft-drop")[0].addEventListener("touchend",()=>{this.fire("cancel","softDrop")}),this.content=t}update(){this._state.container.append(this.content)}}class rt extends S{constructor(){super(...arguments),this.config={squareSizeRatio:.67,shapePadding:5}}setup(){this.width=this._state.width-this._state.initGameState.map._size.col*this._state.squareSize-3,this.height=this._state.height-this._state.squareSize*4,this.squerSize=this._state.squareSize*this.config.squareSizeRatio,this.xShift=this._getXShift()}render(){this.setup();let t=this._state.root.group().addClass("shape-list").translate(0,this._state.squareSize*4);this._container=t.group().addClass("shape-list-container"),this.update(this._state.initGameState)}_generateShape(t,e){let s=this.squerSize,i=t.group().addClass(e._name);for(let o=0;o<e._size;o++)for(let n=0;n<e._size;n++){let r=e._internalMatrix[o][n];if(r.type==="shape"){let l=i.rect(s,s).dx(s*n).dy(s*o);for(let c of r.names)l.addClass(c)}}return i}update(t){if(this._compare(t.shapeQueue,this._lastUpdate)||!t.queueVisible)return;this._container.clear();let e=t.shapeQueue,s=0,i=[];e.forEach((n,r)=>{let l=this._generateShape(this._container,n);i.push(l);let{height:c}=l.bbox();l.translate(this._getXShift(),s+15),s+=c+this.config.shapePadding}),this._container.parent().bbox().height;let o=(this.height-this._container.parent().bbox().height)/e.length-3;i.forEach((n,r)=>n.translate(0,o*r)),this._lastUpdate=e}_getXShift(){const t=this._state.width-this._state.initGameState.map._size.col*this._state.squareSize-3,e=this._state.squareSize*this.config.squareSizeRatio;return(t-4*e)/2}_compare(t,e){return t&&e?!t.some((s,i)=>e[i]?e[i]._name!==s._name:!0):!1}}class R extends S{constructor(){super(...arguments)}render(t){let e=document.createElement("div");e.classList.add("layer-over-background"),this.content=document.createElement("div"),this.content.classList.add("layer-over"),this.content.classList.add("hidden"),t&&this.content.classList.add(t),this.content.append(e);let s=document.createElement("div");s.classList.add("layer-over-wrapper"),s.classList.add(t),this.content.append(s),this._state.container.appendChild(this.content),this.container=this.content,this.content=s}update(t){}show(){this.container.classList.remove("hidden")}hide(){this.container.classList.add("hidden")}}function g(a,t,e,s){let i=`<input class="${t+"-input"}"`;for(let[r,l]of Object.entries(e))i+=" "+r+'="'+l+'" ';i+=`><label class="${t+"-label"}">${a}</label>`;let o=document.createElement("li");o.innerHTML=i,o.classList.add(t),o.classList.add("setting-element");let n=o.children[0];return o.addEventListener("click",r=>{o.classList.toggle("checked"),r.target instanceof HTMLInputElement||(n.checked=!n.checked),r.target.closest("ul").querySelector(".music-on>input").checked||r.target.closest("ul").querySelector(".sound-on>input").checked?r.target.closest("ul").querySelector("li.sound-volume").classList.add("checked"):r.target.closest("ul").querySelector("li.sound-volume").classList.remove("checked"),s&&s(t)}),{liItem:o,inputElement:n}}function x(a,t){const e=document.createElement("button");return e.textContent=a,e.classList.add(t),e}function T(a,t="h2"){let e=document.createElement(t);return e.textContent=a,e}class at extends R{constructor(t){super(t)}render(){super.render("game-setting");let t=T("Game Settings"),{selectSizeDiv:e,sizeElements:s,getSize:i,checkSize:o}=this._renderSelectSize(),{liItem:n,inputElement:r}=g("Show shape queue ","queue",{type:"checkbox"}),{liItem:l,inputElement:c}=g("Show shape projection","projection",{type:"checkbox"}),{liItem:u,inputElement:m}=g("Enable shape autorotate ","auto-rotate",{type:"checkbox"}),{liItem:h,inputElement:z}=g("Turn on game sounds","sound-on",{type:"checkbox"},B.bind(this)),{liItem:M,inputElement:L}=g("Turn on music ","music-on",{type:"checkbox"},B.bind(this)),{liItem:F,inputElement:P}=g("Volume ","sound-volume",{type:"range",min:0,max:100},B.bind(this)),d=this._state.userConfig.gameConfig;d?(d.queueVisible&&(n.classList.add("checked"),r.checked=!0),d.showProjection&&(l.classList.add("checked"),c.checked=!0),d.autoRotate&&(u.classList.add("checked"),m.checked=!0),d.sound.soundOn&&(h.classList.add("checked"),z.checked=!0),d.sound.music&&(M.classList.add("checked"),L.checked=!0),(d.sound.soundOn||d.sound.music)&&(F.classList.add("checked"),P.value=d.sound.volume),o(d.size)):o("standard"),this.startButton=x("start","btn-start"),this.startButton.addEventListener("click",()=>{this.hide();const A={size:i(),queueVisible:r.checked,showProjection:c.checked,autoRotate:m.checked,sound:{soundOn:z.checked,music:L.checked,volume:P.value}};this.fire("start",A)}),this.keyConfigButton=x("key configuration","btn-key-config"),this.keyConfigButton.addEventListener("click",()=>{this.hide(),this.fire("goToKeyConfiguration")});let _=document.createElement("ul");_.classList.add("setting-list"),_.append(e),_.append(n),_.append(l),_.append(u),_.append(h),_.append(M),_.append(F),this.content.append(t),this.content.append(_),this.content.append(this.keyConfigButton),this.content.append(this.startButton);function B(){this.fire("soundConfigurationUpdate",{soundOn:z.checked,music:L.checked,volume:P.value})}}_renderSelectSize(){let t=`
                        <ul class="size-list">
                        <li class="size-list-ratio">
                         <input name="size-radio" type="radio" id="input-size-std" value="standard" checked>
                        <label for="id-size-std">standard 10 x 20</label>
                        </li>
                        <li class="size-list-ratio"  >
                        <input name="size-radio" type="radio" id="input-size-big"  value="big">
                        <label for="id-size-big">big 12 x 24</label>
                        </li>
                        <li class="size-list-ratio" >
                        <input name="size-radio" type="radio" id="input-size-large"  value="large">
                        <label for="id-size-large">large 14 x 28</label>
                        </li>
                       </ul>`,e=document.createElement("li");e.innerHTML=t,e.classList.add("size"),e.classList.add("setting-element");const s={standard:e.querySelector("#input-size-std"),big:e.querySelector("#input-size-big"),large:e.querySelector("#input-size-large")};s.big.parentElement.addEventListener("click",o),s.standard.parentElement.addEventListener("click",o),s.large.parentElement.addEventListener("click",o);function i(l){n(),s[l].closest("li").classList.add("checked"),s[l].checked=!0}function o(l){if(n(),console.log("check"),l.target instanceof HTMLInputElement){l.target.parentElement.classList.add("checked");return}else{let c=l.target.closest("li").children[0];c.checked=!0,c.parentElement.classList.add("checked")}}function n(){for(let l in s)s[l].checked=!1,s[l].parentElement.classList.remove("checked")}return{selectSizeDiv:e,sizeElements:s,getSize:()=>s.standard.checked?"standard":s.big.checked?"big":s.large.checked?"large":"standard",checkSize:i}}update(){}}class lt extends R{constructor(){super(...arguments),this.keyConfigBase=I,this._renderButton=x,this.inputs={}}render(t){this.keyConfigBase=t||this.keyConfigBase,super.render("key-setting");let e=this._renderButton("save","btn-save");e.addEventListener("click",()=>{this.hide();for(let i in this.inputs)this.keyConfigBase.actions[i]=this.inputs[i].value.split(" ");this.fire("saveKeyConfiguration",this.keyConfigBase)});let s=document.createElement("ul");s.classList.add("key-setting-items");for(let i in this.keyConfigBase.actions){let{div:o,input:n}=this._renderActionItem(i,this.keyConfigBase.actions[i]);this.inputs[i]=n,s.append(o)}this.content.append(T("Key configuration")),this.content.append(s),this.content.append(e)}_getHumanActionName(t){const e=/(?<first>[a-z]+)(?<bigLetter>[A-Z]{1})(?<rest>[a-z]+)/;let s=t.match(e);if(s)return i(s.groups.first)+" "+s.groups.bigLetter.toLocaleLowerCase()+s.groups.rest;return i(t);function i(o){return o[0].toUpperCase()+o.substr(1)}}_renderActionItem(t,e){let s=document.createElement("li");s.classList.add("key-setting-item-container"),s.classList.add(t);let i=document.createElement("span");i.classList.add("key-config-item-span"),i.classList.add(t),i.textContent=this._getHumanActionName(t);let o=document.createElement("input");return o.type="text",o.classList.add("key-config-item-input"),o.classList.add(t),o.value=e,o.addEventListener("keydown",function(n){if(n.preventDefault(),n.code==="Backspace"){this.value="";return}this.value.indexOf(n.code)===-1&&(this.value+=(this.value===""?"":" ")+n.code)}),s.append(i),s.append(o),{div:s,input:o}}update(){}}class ct extends R{constructor(){super(...arguments)}render(){super.render("game-over");let t=document.createElement("h4");this.score=document.createElement("span"),t.textContent="score: ",t.classList.add("score"),t.append(this.score);let e=document.createElement("h4");this.level=document.createElement("span"),e.textContent="level: ",e.classList.add("level"),e.append(this.level);let s=document.createElement("h4");s.textContent="time: ",this.time=document.createElement("span"),s.classList.add("time"),s.append(this.time),this.button=document.createElement("button");let i=document.createElement("span");i.textContent="restart";let o=document.createElement("i");o.classList.add("fa"),o.classList.add("fa-undo"),this.button.append(o),this.button.append(i),this.button.classList.add("restart"),this.button.addEventListener("click",()=>{this.hide(),this.fire("restart")});let n=document.createElement("button");n.textContent="settings",n.classList.add("btn-settings"),n.addEventListener("click",()=>{this.hide(),this.fire("settings")});let r=document.createElement("h2");r.textContent="Game Over",this.content.append(r),this.content.append(t),this.content.append(e),this.content.append(s),this.content.append(this.button),this.content.append(n)}update(t){this.score.textContent=t.score,this.level.textContent=t.level,this.time.textContent=new k().stringDescribed(t.time)}}class ht extends R{constructor(){super(...arguments),this.elements={}}render(){super.render("pause"),this.content.append(T("Pause"));for(let c of["score","level","time"]){let{div:u,span:m}=this._renderGameStatEl(c,c+" : ","");this.elements[c]=m,this.content.append(u)}let{liItem:t,inputElement:e}=g("Turn on game sounds","sound-on",{type:"checkbox"},this._soundConfigChanged.bind(this)),{liItem:s,inputElement:i}=g("Turn on music ","music-on",{type:"checkbox"},this._soundConfigChanged.bind(this)),{liItem:o,inputElement:n}=g("Volume ","sound-volume",{type:"range",min:0,max:100},this._soundConfigChanged.bind(this));this.elements.soundOn=[t,e],this.elements.music=[s,i],this.elements.volume=[o,n];let r=document.createElement("ul");r.classList.add("setting-list"),r.append(t),r.append(s),r.append(o),this.content.append(r),console.log(this._state);let l=x("key config","btn-key-config");l.addEventListener("click",()=>this.fire("goToKeySetting")),this.content.append(l)}_renderGameStatEl(t,e,s){let i=document.createElement("div");i.classList.add("game-info-"+t+"-wrapper");let o=document.createElement("h4");o.classList.add("game-info-"+t+"-title"),o.textContent=e;let n=document.createElement("span");return n.classList.add("game-info-"+t+"value"),n.textContent=s,o.append(n),i.append(o),{div:i,span:n}}_soundConfigChanged(){this.fire("soundConfigurationUpdate",{soundOn:this.elements.soundOn[1].checked,music:this.elements.music[1].checked,volume:this.elements.volume[1].value})}update(t,{gameConfig:{sound:e}}){for(let[s,i]of Object.entries(this.elements))if(i instanceof Array){if(i instanceof Array){let[o,n]=i;s==="volume"?(n.value=e[s],(e.soundOn||e.music)&&o.classList.add("checked")):e[s]===!0?(n.checked=!0,o.classList.add("checked")):e[s]===!1&&(n.checked=!1,o.classList.remove("checked")),console.log(e)}}else{if(s==="time"){i.textContent=new k().stringDescribed(t.time);continue}i.textContent=t[s]}}}class ut extends S{constructor(){super(...arguments),this.screens={}}show(t,e,s){switch(t){case"setting":{this._showSetting();break}case"gameOver":{this._showGameOverScreen(e);break}case"pause":{this._showPause(e,s);break}}}hide(t){switch(t){case"pause":this.screens.pause.hide()}}hideAll(){for(let t of Object.values(this.screens))t.hide()}_showPause(t,e){if(this.screens.pauseScreen)this.screens.pauseScreen.update(t,e),this.screens.pauseScreen.show();else{let s=new ht(this._state);s.render(),s.update(t,e),s.show(),s.on("goToKeySetting",()=>{s.hide(),this._createKeySettingScreen(!0)}),s.on("soundConfigurationUpdate",i=>{this.fire("soundConfigurationUpdate",i)}),this.screens.pauseScreen=s}}_showSetting(){let t=new at(this._state);t.render(),t.show(),t.on("start",e=>{this._state.userConfig.gameConfig=e,this.fire("start",this._state.userConfig),t.hide()}),t.on("goToKeyConfiguration",()=>{this._createKeySettingScreen()}),t.on("soundConfigurationUpdate",e=>{this.fire("soundConfigurationUpdate",e)}),this.screens.setting=t}_createKeySettingScreen(t){let e=new lt(this._state);e.render(this._state.userConfig&&this._state.userConfig.keyConfig),e.show(),e.on("saveKeyConfiguration",s=>{t?this.screens.pauseScreen.show():this.screens.setting.show(),this._state.userConfig.keyConfig=s,this.fire("saveKeyConfiguration",s)}),this.screens.keyConfig=e}_createGameOverScreen(){let t=new ct(this._state);t.render(),this.screens.gameOver=t}_showGameOverScreen(t){this._createGameOverScreen();let e=this.screens.gameOver;e.update(t),e.show(),e.on("restart",()=>{console.log("restart ttt"),e.hide(),this.fire("restart"),e.hide()}),e.on("settings",()=>{this.show("setting")})}}class pt extends y{constructor(t,e){super(),this.renderd=!1;let s=t.getBoundingClientRect();this._state={width:s.width,height:s.height,squareSize:null,root:this._createSvgRoot(t),container:t,initGameState:null,userConfig:e||{}},this.menu=new ut(this._state),this.menu.show("setting"),this.mobileControls=new nt(this._state),this.mobileControls.render()}clear(){this._state.root.clear(),this.renderd=!1,this._gameViewElements=null,this._state.container.innerHTML="",this._state.root=this._createSvgRoot(this._state.container)}render(t){this._state.initGameState=t,this._gameViewElements||this._createElements(),!this.renderd&&(this._gameViewElements.forEach(e=>{e.render(this._state)}),this.renderd=!0)}update(t){t.gameOver?this.menu.show("gameOver",t):t.paused?this.menu.show("pause",t,this._state.userConfig):(this.menu.hideAll(),this._gameViewElements.forEach(e=>{e.update(t)}))}_createElements(){this._gameViewElements=[new it(this._state),new ot(this._state),new rt(this._state),this.mobileControls]}_createSvgRoot(t){let e=new SVG;return e.addClass("tetris"),e.addTo("#"+t.id),e.size("100%","100%"),e}}class mt{constructor(t){this._config=t;const e="./app/Games/ClassicTetris/Sound/Resources/";this._sounds={moveFail:e+"move_fail.mp3",moveCorrect:e+"move_correct.mp3",shapeAdd:e+"shape_add.mp3",completedRow:e+"row_completed.mp3",hardDrop:e+"hard_drop.mp3",gameOver:e+"game_over.mp3",background:e+"tetris_background.mp3"},this._players={},t.music&&this.play("background")}play(t){if(this._config.soundOn)switch(t){case"move fail":{this._startPlaying(this._sounds.moveFail);break}case"move correct":{this._startPlaying(this._sounds.moveCorrect);break}case"completed row":{this._startPlaying(this._sounds.completedRow);break}case"game over":{this._startPlaying(this._sounds.gameOver);break}case"hard drop":{this._startPlaying(this._sounds.hardDrop);break}case"shape add":{this._players[this._sounds.completedRow]||this._startPlaying(this._sounds.shapeAdd);break}}}set config(t){this._config=t,this._updatePlayers()}_updatePlayers(){for(let t of Object.values(this._players))t.volume=parseInt(this._config.volume)/100;this._config.music?this._startPlaying(this._sounds.background,!0):this._stopPlaying(this._sounds.background)}_startPlaying(t,e=!1){if(this._players[t])this._players[t].play();else{let s=document.createElement("audio");s.src=t,s.loop=e,s.volume=parseInt(this._config.volume)/100,s.play(),this._players[t]=s,s.addEventListener("ended",()=>{delete this._players[t]})}}_stopPlaying(t){this._players[t]&&(this._players[t].pause(),delete this._players[t])}}class dt extends y{constructor(t,e){super(),this._container=t,this.userConfig=e||{}}_createGame(){this._game=new st,this._view=new pt(this._container,this.userConfig),this._soundPlayer=new mt(this.userConfig.gameConfig.sound),this._game.on("gameOver",t=>this.fire("gameOver",t)),this._game.on("stateUpdate",t=>this._view.update(t)),this._game.on("sound",t=>this._soundPlayer.play(t)),document.addEventListener("keydown",t=>{this._game.keyDown(t.code)}),document.addEventListener("keyup",t=>{this._game.keyUp(t.code)}),this._view.menu.on("start",t=>{this._game.createGame(t),this._view.clear(),this._view.render(this._game.state),this._soundPlayer.config=t.gameConfig.sound,this._game.start(),this.userConfig=t,this.fire("userConfigUpdate",t)}),this._view.menu.on("restart",this.restart.bind(this)),this._view.menu.on("keyConfiguration",t=>{this.userConfig.keyConfig=t,this._game.keyConfiguration=t}),this._view.menu.on("soundConfigurationUpdate",t=>{this.userConfig.gameConfig.sound=t,this._soundPlayer.config=t,this.fire("userConfigUpdate",this.userConfig)}),this._view.mobileControls.on("action",this._game.action.bind(this._game)),this._view.mobileControls.on("cancelAction",this._game.cancel.bind(this._game))}start(){this._createGame()}restart(){this._game?this._game.restart():this.start()}}let ft={keyConfig:{actions:{moveLeft:["ArrowLeft"],moveRight:["ArrowRight"],softDrop:["ArrowDown"],hardDrop:["Space"],rotate:["ArrowUp"],pause:["Escape"],backRotate:["KeyZ"],autoRotate:["KeyR"]}},gameConfig:{size:["standard","big","large"][0],queueVisible:!0,showProjection:!1,autoRotate:!1,sound:{soundOn:!0,music:!1,volume:100}}};class _t{constructor(){const t=document.getElementById("game-container");let e=new dt(t,ft);e.start(),e.on("userConfigUpdate",s=>{console.log("game config changed",s)}),e.on("gameOver",s=>{console.log("game over",s)})}}new _t;
